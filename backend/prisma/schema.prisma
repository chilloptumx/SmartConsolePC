// Prisma schema for Windows PC Health Monitor

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Machine model - represents Windows PCs being monitored
model Machine {
  id          String   @id @default(uuid())
  hostname    String   @unique
  ipAddress   String
  pcModel     String?  // e.g., "Dell Optiplex HP 7000"
  locationId  String?
  status      MachineStatus @default(UNKNOWN)
  lastSeen    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  location    LocationDefinition? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  checkResults CheckResult[]
  jobMachines  JobMachine[]
  auditEvents  AuditEvent[]
  
  @@index([locationId])
  @@map("machines")
}

enum MachineStatus {
  ONLINE
  OFFLINE
  WARNING
  ERROR
  UNKNOWN
}

// Location definitions (name + IPv4 range). Machines get a location assigned based on their ipAddress.
model LocationDefinition {
  id         String   @id @default(uuid())
  name       String   @unique
  // Optional IP range support (not required for manual assignment mode)
  startIp    String?
  endIp      String?
  // Stored as integer ranges for overlap checks and fast matching (IPv4 only).
  // Note: bigint is required for full IPv4 space.
  startIpInt BigInt?
  endIpInt   BigInt?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  machines   Machine[]

  @@map("location_definitions")
}

// Registry check configuration
model RegistryCheck {
  id            String   @id @default(uuid())
  name          String
  registryPath  String   // e.g., "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion"
  valueName     String?  // Specific value to check, null means check if key exists
  expectedValue String?  // Expected value (optional)
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("registry_checks")
}

// File check configuration
model FileCheck {
  id          String   @id @default(uuid())
  name        String
  filePath    String   // e.g., "C:\Windows\System32\drivers\etc\hosts"
  checkExists Boolean  @default(true)
  checkSize   Boolean  @default(false)
  checkCreated Boolean @default(false)
  checkModified Boolean @default(false)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("file_checks")
}

// User check configuration
model UserCheck {
  id           String   @id @default(uuid())
  name         String
  checkType    String   @default("CURRENT_AND_LAST") // "CURRENT_AND_LAST", "CURRENT_ONLY", "LAST_ONLY", "USER_SESSIONS", "CUSTOM"
  customScript String?  // Optional custom PowerShell script
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("user_checks")
}

// System check configuration
model SystemCheck {
  id           String   @id @default(uuid())
  name         String
  checkType    String   @default("SYSTEM_INFO") // "SYSTEM_INFO", "DISK_SPACE", "MEMORY_DETAILS", "CPU_INFO", "NETWORK_INFO", "CUSTOM"
  customScript String?  // Optional custom PowerShell script
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("system_checks")
}

// Scheduled job configuration
model ScheduledJob {
  id              String   @id @default(uuid())
  name            String
  jobType         JobType
  cronExpression  String   // e.g., "*/5 * * * *" for every 5 minutes
  isActive        Boolean  @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  targetAll       Boolean  @default(true) // If true, targets all machines
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relationships
  targetMachines  JobMachine[]
  
  @@map("scheduled_jobs")
}

enum JobType {
  PING
  REGISTRY_CHECK
  FILE_CHECK
  USER_INFO
  SYSTEM_INFO
  FULL_CHECK
}

// Junction table for many-to-many relationship between jobs and machines
model JobMachine {
  id        String @id @default(uuid())
  jobId     String
  machineId String
  
  job       ScheduledJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  machine   Machine      @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  @@unique([jobId, machineId])
  @@map("job_machines")
}

// Check results storage
model CheckResult {
  id         String   @id @default(uuid())
  machineId  String
  checkType  JobType
  checkName  String   // Name of the specific check
  status     CheckStatus
  resultData Json     // Flexible JSON storage for any check result
  message    String?  // Optional message/error description
  duration   Int?     // Duration in milliseconds
  createdAt  DateTime @default(now())
  
  // Relationships
  machine    Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  @@index([machineId, createdAt])
  @@index([checkType, createdAt])
  @@map("check_results")
}

enum CheckStatus {
  SUCCESS
  FAILED
  WARNING
  TIMEOUT
}

enum AuditLevel {
  INFO
  WARN
  ERROR
}

// Job Monitor / Audit log - records notable actions across the system.
model AuditEvent {
  id         String     @id @default(uuid())
  eventType  String
  level      AuditLevel @default(INFO)
  message    String
  machineId  String?
  entityType String?
  entityId   String?
  metadata   Json
  createdAt  DateTime   @default(now())

  machine    Machine?   @relation(fields: [machineId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([eventType, createdAt])
  @@index([machineId, createdAt])
  @@map("audit_events")
}

// Email report configuration
model EmailReport {
  id            String   @id @default(uuid())
  name          String
  recipients    String[] // Array of email addresses
  schedule      String   // Cron expression
  filterConfig  Json     // JSON object with filter criteria
  columns       String[] // Which columns/fields to include
  isActive      Boolean  @default(true)
  lastSentAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("email_reports")
}

// Application settings/configuration
model AppSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("app_settings")
}

